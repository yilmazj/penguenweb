<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nihilist Penguin</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { margin: 0; overflow: hidden; background-color: #dbe4eb; font-family: 'Courier New', Courier, monospace; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        /* Giriş Ekranı UI */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }
        h1 { color: #333; font-size: 2rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 5px; }
        .btn {
            padding: 15px 30px; border: 2px solid #333; background: transparent;
            font-size: 1.2rem; cursor: pointer; transition: 0.3s;
            color: #333; font-weight: bold;
        }
        .btn:hover { background: #333; color: #fff; }

        /* Joystick Alanı */
        #joystick-zone {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            width: 150px; height: 150px; z-index: 5; display: none;
        }
        
        /* Mesaj */
        #message {
            position: absolute; top: 20%; width: 100%; text-align: center;
            color: #555; opacity: 0; transition: opacity 2s; pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>Nihilist Loop</h1>
        <p style="margin-bottom: 30px; font-size: 0.8rem;">Varış noktası yok. Sadece yürüyüş.</p>
        <button class="btn" onclick="startGame(true)">Premium Joystick ile Başla</button>
        <br>
        <button style="border:none; font-size:0.8rem; text-decoration:underline; cursor:pointer;" onclick="startGame(false)">Joystick İstemiyorum</button>
    </div>

    <div id="message">Onlara asla ulaşamazsın...</div>
    <div id="joystick-zone"></div>
    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

    <script>
        let scene, camera, renderer, penguin, ground;
        let otherPenguinsGroup;
        let joystickManager;
        let moveForward = 0;
        let rotateY = 0;
        let isGameActive = false;
        
        // PWA Service Worker Kaydı
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        function startGame(useJoystick) {
            document.getElementById('start-screen').style.display = 'none';
            isGameActive = true;
            init3D();
            
            if (useJoystick) {
                document.getElementById('joystick-zone').style.display = 'block';
                setupJoystick();
            } else {
                // Klavye kontrolleri fallback
                document.addEventListener('keydown', (e) => {
                    if(e.key === "ArrowUp") moveForward = 0.1;
                    if(e.key === "ArrowLeft") rotateY = 0.05;
                    if(e.key === "ArrowRight") rotateY = -0.05;
                });
                document.addEventListener('keyup', (e) => {
                    moveForward = 0; rotateY = 0;
                });
            }
            animate();
        }

        function init3D() {
            scene = new THREE.Scene();
            // Sis efekti: Sonsuzluk hissi için en önemli kısım
            scene.background = new THREE.Color(0xdbe4eb);
            scene.fog = new THREE.FogExp2(0xdbe4eb, 0.02);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Işıklandırma
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(10, 20, 10);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // Zemin (Sonsuz Kar)
            const geometry = new THREE.PlaneGeometry(1000, 1000);
            const material = new THREE.MeshPhongMaterial({ color: 0xffffff });
            ground = new THREE.Mesh(geometry, material);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Ana Karakter (Penguen - Soyut/Low Poly)
            penguin = createPenguin();
            penguin.position.y = 0;
            scene.add(penguin);

            // Uzaktaki Dağlar (Rastgele Piramitler)
            createMountains();

            // Diğer Penguenler (Arkada bekleyenler)
            createMiragePenguins();

            // Kamera Başlangıç Pozisyonu (Arkadan bakış)
            updateCamera();
        }

        function createPenguin() {
            const group = new THREE.Group();
            
            // Gövde
            const bodyGeo = new THREE.CapsuleGeometry(0.5, 1, 4, 8);
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0x111111 }); // Siyah
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 0.75;
            body.castShadow = true;
            
            // Göbek (Beyazlık)
            const bellyGeo = new THREE.CapsuleGeometry(0.4, 0.8, 4, 8);
            const bellyMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
            const belly = new THREE.Mesh(bellyGeo, bellyMat);
            belly.position.set(0, 0.75, 0.15); // Biraz öne çıkar
            
            group.add(body);
            group.add(belly);
            return group;
        }

        function createMountains() {
            for(let i=0; i<20; i++) {
                const h = Math.random() * 30 + 10;
                const geo = new THREE.ConeGeometry(Math.random() * 20 + 10, h, 4);
                const mat = new THREE.MeshPhongMaterial({ color: 0xf0f0f0 });
                const mesh = new THREE.Mesh(geo, mat);
                
                // Rastgele uzak pozisyonlar
                const angle = Math.random() * Math.PI * 2;
                const dist = 80 + Math.random() * 50;
                mesh.position.set(Math.cos(angle)*dist, h/2, Math.sin(angle)*dist);
                scene.add(mesh);
            }
        }

        function createMiragePenguins() {
            otherPenguinsGroup = new THREE.Group();
            // Arkada bir grup penguen
            for(let i=0; i<5; i++) {
                const p = createPenguin();
                p.scale.set(0.8, 0.8, 0.8);
                p.position.set((i-2)*2, 0, -30); // Oyuncunun arkasında (Z negatif)
                otherPenguinsGroup.add(p);
            }
            scene.add(otherPenguinsGroup);
        }

        function setupJoystick() {
            const zone = document.getElementById('joystick-zone');
            joystickManager = nipplejs.create({
                zone: zone,
                mode: 'static',
                position: { left: '50%', top: '50%' },
                color: 'white',
                size: 100,
                fadeTime: 250 // Şeffaf premium hissi
            });

            joystickManager.on('move', function (evt, data) {
                if(data && data.vector) {
                    // Y eksenindeki hareket ileri gitmeyi, X ekseni dönmeyi sağlar
                    moveForward = Math.max(0, data.vector.y) * 0.15; // Geri vites yok, sadece ileri
                    rotateY = -data.vector.x * 0.05;
                }
            });

            joystickManager.on('end', function () {
                moveForward = 0;
                rotateY = 0;
            });
        }

        function updateCamera() {
            // Kamera penguenin arkasında ve biraz yukarısında
            const relativeOffset = new THREE.Vector3(0, 3, -6); // Arkasında
            const cameraOffset = relativeOffset.applyMatrix4(penguin.matrixWorld);
            
            camera.position.lerp(cameraOffset, 0.1); // Yumuşak takip
            camera.lookAt(penguin.position);
        }

        function checkMirageLogic() {
            // Eğer oyuncu arkasını dönüp diğer penguenlere gitmeye çalışırsa
            // Oyuncu ile diğer grup arasındaki mesafeyi ölç
            const dist = penguin.position.distanceTo(otherPenguinsGroup.position);
            
            // Eğer yaklaşıyorsa (mesela 40 birimden yakınsa)
            if (dist < 40) {
                // Diğer penguenleri oyuncunun baktığı vektör yönünde uzaklaştır
                // Bu sonsuz kaçış döngüsünü yaratır
                const fleeDir = new THREE.Vector3().subVectors(otherPenguinsGroup.position, penguin.position).normalize();
                otherPenguinsGroup.position.add(fleeDir.multiplyScalar(moveForward * 1.2)); // Oyuncudan daha hızlı kaçarlar
                
                document.getElementById('message').style.opacity = 1;
            } else {
                document.getElementById('message').style.opacity = 0;
            }
        }

        function animate() {
            requestAnimationFrame(animate);

            if(isGameActive) {
                // Hareket
                penguin.rotation.y += rotateY;
                penguin.translateZ(moveForward);

                // Zemin takibi (Sonsuz zemin illüzyonu)
                ground.position.x = penguin.position.x;
                ground.position.z = penguin.position.z;

                checkMirageLogic();
                updateCamera();
                renderer.render(scene, camera);
            }
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
