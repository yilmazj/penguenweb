<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nihilist Penguin: True Endless</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        body { margin: 0; overflow: hidden; background-color: #d6eef5; user-select: none; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        #joystick-zone {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            width: 150px; height: 150px; z-index: 10;
        }

        #ui-layer {
            position: absolute; top: 20px; left: 20px;
            color: #111; font-weight: bold; font-size: 14px;
            background: rgba(255,255,255,0.6); padding: 10px; border-radius: 10px;
            backdrop-filter: blur(5px); pointer-events: none;
        }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(214, 238, 245, 0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
        }

        button {
            padding: 15px 50px; background: #222; color: #fff; border: none;
            border-radius: 40px; font-size: 18px; font-weight: 600; cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
</head>
<body>

    <div id="start-screen">
        <h1 style="letter-spacing: 4px; margin-bottom: 10px;">SONSUZ YÜRÜYÜŞ</h1>
        <p style="color: #666; margin-bottom: 30px;">Mesafe katediliyor. Ama hedef hep uzak.</p>
        <button id="start-btn">BAŞLA</button>
    </div>

    <div id="ui-layer">
        <div>DÜNYADA KONUM: <span id="dist">0</span>m</div>
        <div style="font-size: 11px; margin-top: 5px; color: #444;">HEDEF UZAKLIĞI: 2000m (SABİT)</div>
    </div>

    <div id="game-container"></div>
    <div id="joystick-zone"></div>

    <script>
        // --- AYARLAR ---
        const CROWD_DISTANCE = 2000;
        const SPEED_FACTOR = 2.5; // Hız çarpanı
        
        let scene, camera, renderer;
        let penguin;
        let ground, groundTex;
        let crowd;
        let mountains = []; // Dağları burada tutacağız
        let joystickManager;
        let moveData = { x: 0, y: 0 };
        let isMoving = false;
        let clock = new THREE.Clock();

        // Başlat
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            init();
            animate();
        });

        function init() {
            // 1. SAHNE VE ATMOSFER (RTX HİSSİ)
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xd6eef5);
            // Sis: Ufuk çizgisini yumuşatır, sonsuzluk hissi verir
            scene.fog = new THREE.FogExp2(0xd6eef5, 0.0012);

            // 2. KAMERA
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 5000);
            camera.position.set(0, 15, 30);

            // 3. IŞIKLAR (GÖLGELENDİRME)
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 0.5); // Gökyüzü/Yer ışığı
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(-80, 150, -50);
            dirLight.castShadow = true;
            
            // Gölge kalitesi
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            dirLight.shadow.camera.far = 1000;
            // Gölge alanını genişlet
            const d = 300;
            dirLight.shadow.camera.left = -d; dirLight.shadow.camera.right = d;
            dirLight.shadow.camera.top = d; dirLight.shadow.camera.bottom = -d;
            scene.add(dirLight);

            // 4. RENDERER
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap; // Yumuşak gölge
            document.getElementById('game-container').appendChild(renderer.domElement);

            // 5. ZEMİN (AKAN DOKU İLE)
            createGround();

            // 6. OYUNCU (PENGUEN)
            createPenguin();

            // 7. ÇEVRE (DAĞLAR VE SÜRÜ)
            createEnvironment();

            // 8. JOYSTICK
            setupJoystick();

            window.addEventListener('resize', onResize);
        }

        function createGround() {
            // Zemin için "Buz Çatlakları" Dokusu oluşturuyoruz
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 512;
            const ctx = canvas.getContext('2d');
            
            // Beyaz Zemin
            ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,512,512);
            
            // Mavi çatlaklar ve gürültü (Hareket hissi için çok önemli)
            for(let i=0; i<8000; i++) {
                ctx.fillStyle = Math.random() > 0.8 ? '#b3e5fc' : '#e1f5fe'; // Açık mavi tonları
                ctx.beginPath();
                const x = Math.random() * 512;
                const y = Math.random() * 512;
                const r = Math.random() * 2;
                ctx.arc(x, y, r, 0, Math.PI*2);
                ctx.fill();
            }
            // Izgara çizgileri ekleyelim (Hızı hissettirmek için en iyisi)
            ctx.strokeStyle = 'rgba(179, 229, 252, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for(let i=0; i<=512; i+=64) {
                ctx.moveTo(i, 0); ctx.lineTo(i, 512);
                ctx.moveTo(0, i); ctx.lineTo(512, i);
            }
            ctx.stroke();

            groundTex = new THREE.CanvasTexture(canvas);
            groundTex.wrapS = THREE.RepeatWrapping;
            groundTex.wrapT = THREE.RepeatWrapping;
            // Dokuyu çok tekrarla ki detaylı görünsün
            groundTex.repeat.set(50, 50); 

            const geo = new THREE.PlaneGeometry(1000, 1000); // Oyuncunun etrafında bir alan
            const mat = new THREE.MeshStandardMaterial({ 
                map: groundTex, 
                roughness: 0.8,
                metalness: 0.1
            });
            ground = new THREE.Mesh(geo, mat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        function createPenguin() {
            penguin = new THREE.Group();

            // Gövde (Detaylı)
            const bodyGeo = new THREE.CapsuleGeometry(3, 7, 4, 16);
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.6 });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.position.y = 5.5;
            body.castShadow = true;
            penguin.add(body);

            // Beyaz Karın
            const bellyGeo = new THREE.CapsuleGeometry(2.8, 6, 4, 16);
            const bellyMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.9 });
            const belly = new THREE.Mesh(bellyGeo, bellyMat);
            belly.position.set(0, 5.5, 0.8);
            penguin.add(belly);

            // Gaga
            const beakGeo = new THREE.ConeGeometry(0.5, 2.5, 16);
            const beakMat = new THREE.MeshStandardMaterial({ color: 0xff9800 });
            const beak = new THREE.Mesh(beakGeo, beakMat);
            beak.rotation.x = Math.PI/2;
            beak.position.set(0, 9, 3.2);
            penguin.add(beak);

            // Gözler
            const eyeGeo = new THREE.SphereGeometry(0.35);
            const eyeMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
            const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
            eyeL.position.set(-1.1, 9.5, 2.6);
            penguin.add(eyeL);
            const eyeR = new THREE.Mesh(eyeGeo, eyeMat);
            eyeR.position.set(1.1, 9.5, 2.6);
            penguin.add(eyeR);

            // Kanatlar (Aşağı ve Hafif Açık)
            const wingGeo = new THREE.BoxGeometry(1, 5, 2.5);
            const wingL = new THREE.Mesh(wingGeo, bodyMat);
            wingL.position.set(3.5, 6, 0);
            wingL.rotation.z = -0.4;
            wingL.castShadow = true;
            penguin.add(wingL);

            const wingR = new THREE.Mesh(wingGeo, bodyMat);
            wingR.position.set(-3.5, 6, 0);
            wingR.rotation.z = 0.4;
            wingR.castShadow = true;
            penguin.add(wingR);

            scene.add(penguin);
        }

        function createEnvironment() {
            // 1. Sürü (Hedef) - Uzaktaki siyah noktalar
            crowd = new THREE.Group();
            const pGeo = new THREE.CapsuleGeometry(2, 5, 4, 8);
            const pMat = new THREE.MeshBasicMaterial({ color: 0x000000 });

            for(let i=0; i<150; i++) {
                const p = new THREE.Mesh(pGeo, pMat);
                p.position.set(
                    (Math.random()-0.5)*400, // Geniş alana yayıl
                    2.5, 
                    Math.random()*100
                );
                crowd.add(p);
            }
            crowd.position.z = -CROWD_DISTANCE;
            scene.add(crowd);

            // 2. Sonsuz Dağlar Sistemi
            // Başlangıçta oyuncunun önüne ve yanlarına bolca dağ koyuyoruz
            const mtGeo = new THREE.ConeGeometry(120, 300, 5); // Low Poly Dağ
            const mtMat = new THREE.MeshStandardMaterial({ 
                color: 0xf0f8ff, // Buz beyazı
                flatShading: true,
                roughness: 1
            });

            // İlk etapta 3000 metre boyunca dağ dizelim
            for(let i=0; i<60; i++) {
                // Rastgele z pozisyonu (İleriye doğru)
                let zPos = -Math.random() * 3000;
                spawnMountain(mtGeo, mtMat, zPos);
            }
        }

        function spawnMountain(geo, mat, zPos) {
            const mt = new THREE.Mesh(geo, mat);
            // Yolun ortasını boş bırak (sağ sol)
            const side = Math.random() > 0.5 ? 1 : -1;
            const distFromCenter = 300 + Math.random() * 600; // 300m ile 900m arası uzaklık
            
            mt.position.set(side * distFromCenter, -50, zPos);
            
            // Rastgele boyut
            const s = 1 + Math.random() * 2.5;
            mt.scale.set(s,s,s);
            
            mt.castShadow = true;
            scene.add(mt);
            mountains.push(mt); // Listeye ekle ki sonra kontrol edebilelim
        }

        function setupJoystick() {
            joystickManager = nipplejs.create({
                zone: document.getElementById('joystick-zone'),
                mode: 'static',
                position: { left: '50%', top: '50%' },
                color: 'rgba(0,0,0,0.6)',
                size: 120
            });
            
            joystickManager.on('move', (evt, data) => {
                if(data.vector) { moveData = data.vector; isMoving = true; }
            });
            joystickManager.on('end', () => { isMoving = false; moveData = {x:0, y:0}; });
        }

        // --- OYUN DÖNGÜSÜ ---
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            if (isMoving && penguin) {
                // HAREKET MANTIĞI
                // Joystick Y (yukarı) -> Z (ileri -negatif)
                const moveZ = moveData.y * SPEED_FACTOR;
                const moveX = moveData.x * 1.5;

                // Sadece ileri gidiliyorsa (Geri vites yok)
                if(moveData.y > 0) {
                    // 1. PENGUEN İLERLİYOR (Koordinat değişiyor)
                    penguin.position.z -= moveZ;

                    // 2. NİHİLİZM: Sürü de kaçıyor
                    crowd.position.z = penguin.position.z - CROWD_DISTANCE;
                    
                    // 3. DAĞLARI DÖNDÜR (SONSUZ DÜNYA)
                    // Eğer bir dağ kameranın arkasında kaldıysa (z > penguin.z + offset),
                    // onu alıp en öne (penguin.z - 3000) ışınlıyoruz.
                    mountains.forEach(mt => {
                        if(mt.position.z > penguin.position.z + 100) {
                            mt.position.z = penguin.position.z - 3000 - (Math.random() * 500);
                            // Tarafını da değiştirelim ki monoton olmasın
                            const side = Math.random() > 0.5 ? 1 : -1;
                            const dist = 300 + Math.random() * 600;
                            mt.position.x = side * dist;
                        }
                    });
                }

                // Sağa Sola Hareket
                penguin.position.x += moveX;
                penguin.position.x = Math.max(-250, Math.min(250, penguin.position.x)); // Sınır

                // PAYTAK YÜRÜYÜŞ (Waddle)
                const waddleSpeed = 12;
                const waddleAmp = 0.15;
                penguin.rotation.z = Math.sin(time * waddleSpeed) * waddleAmp * -1;
                // Zıplama efekti
                penguin.position.y = 5.5 + Math.abs(Math.sin(time * waddleSpeed)) * 0.5;

            } else {
                // Durma animasyonu
                if(penguin) {
                    penguin.rotation.z *= 0.9;
                    penguin.position.y = 5.5 + Math.sin(time * 2) * 0.2;
                }
            }

            // KAMERA VE DÜNYA SENKRONİZASYONU
            if(penguin) {
                // 1. Kamera Takibi (Subway Surfers gibi smooth)
                const targetZ = penguin.position.z + 40;
                const targetX = penguin.position.x * 0.5; // Hafifçe yana kay
                
                camera.position.z += (targetZ - camera.position.z) * 0.1;
                camera.position.x += (targetX - camera.position.x) * 0.1;
                camera.lookAt(penguin.position.x, 6, penguin.position.z - 50);

                // 2. ZEMİN TAKİBİ (ÇOK ÖNEMLİ)
                // Zemin mesh'i oyuncuyu takip eder (böylece düşmeyiz)
                ground.position.z = penguin.position.z;
                
                // 3. ZEMİN DOKU AKIŞI (SPEED ILLUSION)
                // Mesh hareket ediyor ama Texture'ı dünya koordinatlarına kilitliyoruz.
                // Texture offset'i pozisyona göre ayarlayarak sanki yerimizde durmuyoruz,
                // gerçek bir zeminde gidiyoruz hissi veriyoruz.
                groundTex.offset.y = -penguin.position.z / 20; // 20: Doku ölçeği
                groundTex.offset.x = -penguin.position.x / 20;
            }

            // UI Güncelle
            if(penguin) {
                document.getElementById('dist').innerText = Math.floor(Math.abs(penguin.position.z));
            }

            renderer.render(scene, camera);
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>